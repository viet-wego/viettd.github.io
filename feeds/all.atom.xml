<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Viet Tran</title><link href="https://viettran.me/" rel="alternate"></link><link href="https://viettran.me/feeds/all.atom.xml" rel="self"></link><id>https://viettran.me/</id><updated>2018-11-25T18:59:00+08:00</updated><entry><title>Scale out a Redis cluster</title><link href="https://viettran.me/scale-redis-cluster.html" rel="alternate"></link><published>2018-11-15T18:40:00+08:00</published><updated>2018-11-25T18:59:00+08:00</updated><author><name>Viet Tran</name></author><id>tag:viettran.me,2018-11-15:/scale-redis-cluster.html</id><summary type="html">&lt;p&gt;How to scale out a Redis cluster (add more nodes to the cluster).&lt;/p&gt;</summary><content type="html">&lt;p&gt;&lt;strong&gt;Update:&lt;/strong&gt; &lt;em&gt;This tutorial is for Redis 3 &amp;amp; 4. With Redis 5 the work can be done with &lt;code&gt;redis-cli&lt;/code&gt; tool.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Scaling a &lt;a href="https://redis.io/topics/cluster-spec"&gt;Redis cluster&lt;/a&gt; sounds like a difficult task to someone never done it before.
But luckily &lt;a href="https://redis.io/"&gt;Redis team&lt;/a&gt; has done a nice work. They provides the &lt;code&gt;redis-trib&lt;/code&gt; tool to help us with some cluster tasks.
This tutorial will show you how easy it is.&lt;/p&gt;
&lt;h2&gt;What we need&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;A working &lt;a href="https://redis.io/topics/cluster-spec"&gt;Redis cluster&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;&lt;a href="https://www.ruby-lang.org/en/"&gt;Ruby&lt;/a&gt;.&lt;/li&gt;
&lt;li&gt;&lt;a href="https://rubygems.org/gems/redis/versions/4.0.3"&gt;Redis gem&lt;/a&gt;. Remember to choose the compatible version of Redis gem with your Redis version.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Let's do it&lt;/h2&gt;
&lt;p&gt;We will start with checking current status of the cluster with this command below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;redis-trib.rb info &lt;span class="m"&gt;10&lt;/span&gt;.20.0.1:6379
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;em&gt;&lt;code&gt;6379&lt;/code&gt; is Redis running port of host &lt;code&gt;10.20.0.1&lt;/code&gt;.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;We should see something like this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;.20.0.1:6379 &lt;span class="o"&gt;(&lt;/span&gt;4f002e35...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4320889&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1366&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.2:6379 &lt;span class="o"&gt;(&lt;/span&gt;a2d2d8f4...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4304402&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1366&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.3:6379 &lt;span class="o"&gt;(&lt;/span&gt;b021ccf0...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4163969&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1366&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.4:6379 &lt;span class="o"&gt;(&lt;/span&gt;0dd0889b...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4183495&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1366&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.5:6379 &lt;span class="o"&gt;(&lt;/span&gt;d94a5bed...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4269335&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1366&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.6:6379 &lt;span class="o"&gt;(&lt;/span&gt;3229648e...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4206758&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1359&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.7:6379 &lt;span class="o"&gt;(&lt;/span&gt;2bb07de3...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4484283&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1365&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.8:6379 &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;44138262&lt;/span&gt;...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4118749&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1366&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.9:6379 &lt;span class="o"&gt;(&lt;/span&gt;fa6af69a...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4237922&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1366&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.10:6379 &lt;span class="o"&gt;(&lt;/span&gt;a5f5e5c5...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4165017&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1366&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.11:6379 &lt;span class="o"&gt;(&lt;/span&gt;f4d9872d...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4326251&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1366&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.12:6379 &lt;span class="o"&gt;(&lt;/span&gt;102ca6bc...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4140947&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1366&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="o"&gt;[&lt;/span&gt;OK&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="m"&gt;50922208&lt;/span&gt; keys in &lt;span class="m"&gt;12&lt;/span&gt; masters.
&lt;span class="m"&gt;3108&lt;/span&gt;.04 keys per slot on average.
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Here we have 12 masters with 0 slaves. Now we can add new node to current cluster. &lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;redis-trib.rb add-node &lt;span class="m"&gt;10&lt;/span&gt;.20.0.13:6379 &lt;span class="m"&gt;10&lt;/span&gt;.20.0.1:6379
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;em&gt;&lt;code&gt;10.20.0.13:6379&lt;/code&gt; is host &amp;amp; port of new node.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;The out put is:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&amp;gt;&amp;gt;&amp;gt; Adding node &lt;span class="m"&gt;10&lt;/span&gt;.20.0.13:6379 to cluster &lt;span class="m"&gt;10&lt;/span&gt;.20.0.1:6379
&amp;gt;&amp;gt;&amp;gt; Performing Cluster Check &lt;span class="o"&gt;(&lt;/span&gt;using node &lt;span class="m"&gt;10&lt;/span&gt;.20.0.1:6379&lt;span class="o"&gt;)&lt;/span&gt;
M: 4f002e3542ea6a91bfba5352a0f58d439a213a81 &lt;span class="m"&gt;10&lt;/span&gt;.20.0.1:6379
slots:5463-6828 &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;1366&lt;/span&gt; slots&lt;span class="o"&gt;)&lt;/span&gt; master
&lt;span class="m"&gt;0&lt;/span&gt; additional replica&lt;span class="o"&gt;(&lt;/span&gt;s&lt;span class="o"&gt;)&lt;/span&gt;
...
... &amp;lt;There are more information here&amp;gt; ...
...
&lt;span class="o"&gt;[&lt;/span&gt;OK&lt;span class="o"&gt;]&lt;/span&gt; All nodes agree about slots configuration.
&amp;gt;&amp;gt;&amp;gt; Check &lt;span class="k"&gt;for&lt;/span&gt; open slots...
&amp;gt;&amp;gt;&amp;gt; Check slots coverage...
&lt;span class="o"&gt;[&lt;/span&gt;OK&lt;span class="o"&gt;]&lt;/span&gt; All &lt;span class="m"&gt;16384&lt;/span&gt; slots covered.
&amp;gt;&amp;gt;&amp;gt; Send CLUSTER MEET to node &lt;span class="m"&gt;10&lt;/span&gt;.20.0.13:6379 to make it join the cluster.
&lt;span class="o"&gt;[&lt;/span&gt;OK&lt;span class="o"&gt;]&lt;/span&gt; New node added correctly.
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Now if we check the cluster status again, we will see that a new node has been added to the cluster.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;.20.0.1:6379 &lt;span class="o"&gt;(&lt;/span&gt;4f002e35...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4329319&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1366&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.2:6379 &lt;span class="o"&gt;(&lt;/span&gt;a2d2d8f4...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4523277&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1366&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.3:6379 &lt;span class="o"&gt;(&lt;/span&gt;b021ccf0...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4206106&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1366&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.4:6379 &lt;span class="o"&gt;(&lt;/span&gt;0dd0889b...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4421096&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1366&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.5:6379 &lt;span class="o"&gt;(&lt;/span&gt;d94a5bed...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4252139&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1366&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.6:6379 &lt;span class="o"&gt;(&lt;/span&gt;3229648e...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4381794&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1359&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.7:6379 &lt;span class="o"&gt;(&lt;/span&gt;2bb07de3...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4520956&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1365&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.8:6379 &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;44138262&lt;/span&gt;...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4177448&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1366&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.9:6379 &lt;span class="o"&gt;(&lt;/span&gt;fa6af69a...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4442986&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1366&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.10:6379 &lt;span class="o"&gt;(&lt;/span&gt;a5f5e5c5...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4279561&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1366&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.11:6379 &lt;span class="o"&gt;(&lt;/span&gt;f4d9872d...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4567149&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1366&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.12:6379 &lt;span class="o"&gt;(&lt;/span&gt;102ca6bc...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4483896&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1366&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.13:6379 &lt;span class="o"&gt;(&lt;/span&gt;ebadd321...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;0&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="o"&gt;[&lt;/span&gt;OK&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="m"&gt;52585715&lt;/span&gt; keys in &lt;span class="m"&gt;13&lt;/span&gt; masters.
&lt;span class="m"&gt;3209&lt;/span&gt;.58 keys per slot on average.
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;We added 1 node to the cluster. Then we need to assign &lt;code&gt;key hash slots&lt;/code&gt; to it. The number of slots per node will be &lt;code&gt;16384/(12+1) ~ 1260&lt;/code&gt;.
Before do it, we need to get the &lt;code&gt;node id&lt;/code&gt; of new node:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;redis-cli -h &lt;span class="m"&gt;10&lt;/span&gt;.20.0.13 -p &lt;span class="m"&gt;6379&lt;/span&gt; cluster nodes
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Output:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;4f002e3542ea6a91bfba5352a0f58d439a213a81 &lt;span class="m"&gt;10&lt;/span&gt;.20.0.1:6379 master - &lt;span class="m"&gt;0&lt;/span&gt; &lt;span class="m"&gt;1542268658727&lt;/span&gt; &lt;span class="m"&gt;20&lt;/span&gt; connected &lt;span class="m"&gt;0&lt;/span&gt;-1365
a2d2d8f40e60443e24f6fb71101ce7f8eeacf6a1 &lt;span class="m"&gt;10&lt;/span&gt;.20.0.2:6379 master - &lt;span class="m"&gt;0&lt;/span&gt; &lt;span class="m"&gt;1542268658435&lt;/span&gt; &lt;span class="m"&gt;22&lt;/span&gt; connected &lt;span class="m"&gt;1366&lt;/span&gt;-2730
b021ccf07f42659fd41b7bdd93ed13c1bf6ba086 &lt;span class="m"&gt;10&lt;/span&gt;.20.0.3:6379 master - &lt;span class="m"&gt;0&lt;/span&gt; &lt;span class="m"&gt;1542268659024&lt;/span&gt; &lt;span class="m"&gt;19&lt;/span&gt; connected &lt;span class="m"&gt;2732&lt;/span&gt;-4097
0dd0889bceb8635a1ff717215c10ef7977795329 &lt;span class="m"&gt;10&lt;/span&gt;.20.0.4:6379 master - &lt;span class="m"&gt;0&lt;/span&gt; &lt;span class="m"&gt;1542268659313&lt;/span&gt; &lt;span class="m"&gt;24&lt;/span&gt; connected &lt;span class="m"&gt;4097&lt;/span&gt;-5463
d94a5bed1bfb6a79667d5098eb60452771b7b53b &lt;span class="m"&gt;10&lt;/span&gt;.20.0.5:6379 master - &lt;span class="m"&gt;0&lt;/span&gt; &lt;span class="m"&gt;1542268658045&lt;/span&gt; &lt;span class="m"&gt;26&lt;/span&gt; connected &lt;span class="m"&gt;5464&lt;/span&gt;-6829
3229648e1517680ea813735c45c143bc79607328 &lt;span class="m"&gt;10&lt;/span&gt;.20.0.6:6379 master - &lt;span class="m"&gt;0&lt;/span&gt; &lt;span class="m"&gt;1542268659313&lt;/span&gt; &lt;span class="m"&gt;29&lt;/span&gt; connected &lt;span class="m"&gt;6830&lt;/span&gt;-8188
2bb07de3a1e71cd5190d49d7cf5ba8c492c23b2c &lt;span class="m"&gt;10&lt;/span&gt;.20.0.7:6379 master - &lt;span class="m"&gt;0&lt;/span&gt; &lt;span class="m"&gt;1542268658435&lt;/span&gt; &lt;span class="m"&gt;16&lt;/span&gt; connected &lt;span class="m"&gt;8189&lt;/span&gt;-9553
44138262ca209f7b119c8d726921b4261d2ea77a &lt;span class="m"&gt;10&lt;/span&gt;.20.0.8:6379 master - &lt;span class="m"&gt;0&lt;/span&gt; &lt;span class="m"&gt;1542268658533&lt;/span&gt; &lt;span class="m"&gt;21&lt;/span&gt; connected &lt;span class="m"&gt;9554&lt;/span&gt;-10919
fa6af69a3f0a02c624aa08508973f853c7ae905f &lt;span class="m"&gt;10&lt;/span&gt;.20.0.9:6379 master - &lt;span class="m"&gt;0&lt;/span&gt; &lt;span class="m"&gt;1542268658045&lt;/span&gt; &lt;span class="m"&gt;17&lt;/span&gt; connected &lt;span class="m"&gt;10920&lt;/span&gt;-12285
a5f5e5c59e5a9ba41de42aff6941224e780fc231 &lt;span class="m"&gt;10&lt;/span&gt;.20.0.10:6379 master - &lt;span class="m"&gt;0&lt;/span&gt; &lt;span class="m"&gt;1542268658240&lt;/span&gt; &lt;span class="m"&gt;25&lt;/span&gt; connected &lt;span class="m"&gt;12286&lt;/span&gt;-13651
f4d9872de81137126376698f757ad477cdaaf5ca &lt;span class="m"&gt;10&lt;/span&gt;.20.0.11:6379 master - &lt;span class="m"&gt;0&lt;/span&gt; &lt;span class="m"&gt;1542268658923&lt;/span&gt; &lt;span class="m"&gt;23&lt;/span&gt; connected &lt;span class="m"&gt;13652&lt;/span&gt;-15017
102ca6bc5269221bf29483c906e0f43e8433c437 &lt;span class="m"&gt;10&lt;/span&gt;.20.0.12:6379 master - &lt;span class="m"&gt;0&lt;/span&gt; &lt;span class="m"&gt;1542268659704&lt;/span&gt; &lt;span class="m"&gt;18&lt;/span&gt; connected &lt;span class="m"&gt;15018&lt;/span&gt;-16383
ebadd3216f2ea34d37c66f4c5cd0fd6edd0df48c &lt;span class="m"&gt;10&lt;/span&gt;.20.0.13:6379 myself,master - &lt;span class="m"&gt;0&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; &lt;span class="m"&gt;27&lt;/span&gt; connected
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The new node has &lt;code&gt;id=ebadd3216f2ea34d37c66f4c5cd0fd6edd0df48c&lt;/code&gt;. Okay, now we reshard the cluster&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;redis-trib.rb reshard &lt;span class="m"&gt;10&lt;/span&gt;.20.0.1:6379
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The command prompt will ask us a few questions. Answer it with our information as below:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;How many slots &lt;span class="k"&gt;do&lt;/span&gt; you want to move &lt;span class="o"&gt;(&lt;/span&gt;from &lt;span class="m"&gt;1&lt;/span&gt; to &lt;span class="m"&gt;16384&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;? &lt;span class="m"&gt;1260&lt;/span&gt;
What is the receiving node ID? ebadd3216f2ea34d37c66f4c5cd0fd6edd0df48c
Please enter all the &lt;span class="nb"&gt;source&lt;/span&gt; node IDs.
        Type &lt;span class="s1"&gt;&amp;#39;all&amp;#39;&lt;/span&gt; to use all the nodes as &lt;span class="nb"&gt;source&lt;/span&gt; nodes &lt;span class="k"&gt;for&lt;/span&gt; the &lt;span class="nb"&gt;hash&lt;/span&gt; slots.
        Type &lt;span class="s1"&gt;&amp;#39;done&amp;#39;&lt;/span&gt; once you entered all the &lt;span class="nb"&gt;source&lt;/span&gt; nodes IDs.
Source node &lt;span class="c1"&gt;#1:all&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Then it will propose a plan to migrate hash slots to new node. We will accept the plan by saying &lt;code&gt;yes&lt;/code&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;Do you want to proceed with the proposed reshard plan &lt;span class="o"&gt;(&lt;/span&gt;yes/no&lt;span class="o"&gt;)&lt;/span&gt;? yes
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Let it run. In the mean time, we can enjoy a coffee. After it finishs we will get the result like this when check cluster status:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;.20.0.1:6379 &lt;span class="o"&gt;(&lt;/span&gt;4f002e35...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4041336&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1261&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.2:6379 &lt;span class="o"&gt;(&lt;/span&gt;a2d2d8f4...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4050861&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1261&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.3:6379 &lt;span class="o"&gt;(&lt;/span&gt;b021ccf0...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;3891858&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1261&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.4:6379 &lt;span class="o"&gt;(&lt;/span&gt;0dd0889b...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4017233&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1261&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.5:6379 &lt;span class="o"&gt;(&lt;/span&gt;d94a5bed...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4024559&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1260&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.6:6379 &lt;span class="o"&gt;(&lt;/span&gt;3229648e...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4101075&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1260&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.7:6379 &lt;span class="o"&gt;(&lt;/span&gt;2bb07de3...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4043998&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1260&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.8:6379 &lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="m"&gt;44138262&lt;/span&gt;...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;3953209&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1260&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.9:6379 &lt;span class="o"&gt;(&lt;/span&gt;fa6af69a...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;3984349&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1260&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.10:6379 &lt;span class="o"&gt;(&lt;/span&gt;a5f5e5c5...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;3924321&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1260&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.11:6379 &lt;span class="o"&gt;(&lt;/span&gt;f4d9872d...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;4074297&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1260&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.12:6379 &lt;span class="o"&gt;(&lt;/span&gt;102ca6bc...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;3993498&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1260&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="m"&gt;10&lt;/span&gt;.20.0.13:6379 &lt;span class="o"&gt;(&lt;/span&gt;ebadd321...&lt;span class="o"&gt;)&lt;/span&gt; -&amp;gt; &lt;span class="m"&gt;3837590&lt;/span&gt; keys &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;1260&lt;/span&gt; slots &lt;span class="p"&gt;|&lt;/span&gt; &lt;span class="m"&gt;0&lt;/span&gt; slaves.
&lt;span class="o"&gt;[&lt;/span&gt;OK&lt;span class="o"&gt;]&lt;/span&gt; &lt;span class="m"&gt;51938197&lt;/span&gt; keys in &lt;span class="m"&gt;13&lt;/span&gt; masters.
&lt;span class="m"&gt;3170&lt;/span&gt;.06 keys per slot on average.
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Now our cluster is scaled.&lt;/p&gt;
&lt;hr&gt;
&lt;h2&gt;References&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://redis.io/topics/cluster-tutorial"&gt;Redis cluster tutorial&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><category term="devops"></category><category term="redis"></category><category term="cluster"></category><category term="scale"></category><category term="tutorial"></category></entry><entry><title>Create &amp; Format a Disk on GCE</title><link href="https://viettran.me/create-n-format-a-disk-on-gce.html" rel="alternate"></link><published>2018-11-08T18:40:00+08:00</published><updated>2018-11-08T18:59:00+08:00</updated><author><name>Viet Tran</name></author><id>tag:viettran.me,2018-11-08:/create-n-format-a-disk-on-gce.html</id><summary type="html">&lt;p&gt;How to create, format and use a disk on Google Compute Engine.&lt;/p&gt;</summary><content type="html">&lt;p&gt;This is the short version to help you do the task. If you want to learn more please check the References at the end of this article.&lt;/p&gt;
&lt;h2&gt;Create a new disk&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;gcloud compute disks create dev-postgres-master --size&lt;span class="o"&gt;=&lt;/span&gt;500GB --type&lt;span class="o"&gt;=&lt;/span&gt;pd-ssd
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;&lt;code&gt;dev-postgres-master&lt;/code&gt; is my disk name&lt;/li&gt;
&lt;li&gt;&lt;code&gt;type&lt;/code&gt; can be &lt;code&gt;pd-ssd&lt;/code&gt; or &lt;code&gt;pd-standard&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Create a temporary instance &amp;amp; attach the disk&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;gcloud compute instances create viet-temp
gcloud compute instances attach-disk viet-temp --disk&lt;span class="o"&gt;=&lt;/span&gt;dev-postgres-master
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;&lt;code&gt;viet-temp&lt;/code&gt; is my instance name&lt;/li&gt;
&lt;li&gt;&lt;code&gt;dev-postgres-master&lt;/code&gt; is name of the disk created above&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Format the new disk&lt;/h2&gt;
&lt;p&gt;SSH to the instance has the new disk&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;gcloud compute ssh viet-temp
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;When you're inside the instance:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;List all devices are attached to server&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo lsblk
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;You will get the output like this&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sdb      &lt;span class="m"&gt;8&lt;/span&gt;:16   &lt;span class="m"&gt;0&lt;/span&gt;  500G  &lt;span class="m"&gt;0&lt;/span&gt; disk
sda      &lt;span class="m"&gt;8&lt;/span&gt;:0    &lt;span class="m"&gt;0&lt;/span&gt;   64G  &lt;span class="m"&gt;0&lt;/span&gt; disk
└─sda1   &lt;span class="m"&gt;8&lt;/span&gt;:1    &lt;span class="m"&gt;0&lt;/span&gt;   64G  &lt;span class="m"&gt;0&lt;/span&gt; part /
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;In this case, my new disk is &lt;code&gt;/dev/sbd&lt;/code&gt;, I will format it with these commands&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo mkfs.ext4 -m &lt;span class="m"&gt;0&lt;/span&gt; -F -E &lt;span class="nv"&gt;lazy_itable_init&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;,lazy_journal_init&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;,discard /dev/sdb
sudo mkdir -p /data
sudo mount /dev/sdb /data
sudo chmod -R &lt;span class="m"&gt;777&lt;/span&gt; /data
sudo umount /data
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Then exit the server.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Detach the disk &amp;amp; delete the temporary instance&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;gcloud compute instances detach-disk viet-temp --disk&lt;span class="o"&gt;=&lt;/span&gt;dev-postgres-master
gcloud compute instance delete viet-temp
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Now, your new disk is ready to use as a &lt;code&gt;ext4&lt;/code&gt; volumne.&lt;/p&gt;
&lt;hr&gt;
&lt;h2&gt;References&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href="https://cloud.google.com/compute/docs/disks/add-persistent-disk"&gt;Adding or Resizing Persistent Disks&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href="https://cloud.google.com/sdk/gcloud/reference/compute/disks/create"&gt;gcloud compute disks create&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</content><category term="devops"></category><category term="gcloud"></category><category term="linux"></category><category term="gcp"></category><category term="gce"></category><category term="vm"></category><category term="disk"></category></entry><entry><title>Setup replication for PostgreSQL</title><link href="https://viettran.me/setup-replication-for-postgresql.html" rel="alternate"></link><published>2018-11-07T20:00:00+08:00</published><updated>2018-11-07T20:00:00+08:00</updated><author><name>Viet Tran</name></author><id>tag:viettran.me,2018-11-07:/setup-replication-for-postgresql.html</id><summary type="html">&lt;p&gt;How to setup replication for PostgreSQL using hot stanby.&lt;/p&gt;</summary><content type="html">&lt;p&gt;If you want to understand about high availability,load balancing and replication in PostgreSQL, please read the official documentation in the &lt;a href="#References"&gt;References&lt;/a&gt;. In this tutorial, I will show you how to set up a replication server for PostgreSQL using Hot Stanby mode.&lt;/p&gt;
&lt;h2&gt;Install PostgreSQL&lt;/h2&gt;
&lt;p&gt;You will need 2 instances of PostgreSQL. For detail please see &lt;a href="https://viettran.me/install-n-configure-postgresql-on-ubuntu.html"&gt;Install &amp;amp; configure PostgreSQL on Ubuntu&lt;/a&gt;.&lt;/p&gt;
&lt;h2&gt;Prepare Master Server&lt;/h2&gt;
&lt;h5&gt;Create a user for replication &amp;amp; allow traffic for replication server&lt;/h5&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo -u postgres createuser -U postgres rep_user -P -c &lt;span class="m"&gt;5&lt;/span&gt; --replication
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;Replace &lt;code&gt;rep_user&lt;/code&gt; with your replication user.&lt;/li&gt;
&lt;li&gt;Replace &lt;code&gt;5&lt;/code&gt; with max connections can be used for replication.&lt;/li&gt;
&lt;li&gt;Your will need to provide a powerful password for this user at the command prompt.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Edit &lt;strong&gt;pg_hba.conf&lt;/strong&gt; file. By default, you can find it at &lt;code&gt;/etc/postgresql/[your_postgresql_version]/main/pg_hba.conf&lt;/code&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo vi /etc/postgresql/10/main/pg_hba.conf
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Allow replication connections&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# Allow replication connections for user rep_user from 10.240.0.0/16 with md5 password&lt;/span&gt;
host    replication     rep_user             &lt;span class="m"&gt;10&lt;/span&gt;.240.0.0/16           md5
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;If you want to only allow from 1 specific IP, can use CIDR &lt;code&gt;[your_replication_server_ip]/32&lt;/code&gt;. E.g: 10.240.0.10/32&lt;/p&gt;
&lt;h5&gt;Configure WAL (Write Ahead Log)&lt;/h5&gt;
&lt;p&gt;Create a directory to store archive file&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;mkdir -p /data/postgresql/10/main/archive
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Edit &lt;strong&gt;postgresql.conf&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo vi /etc/postgresql/10/main/postgresql.conf
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;PostgreSQL &amp;gt;= 9.6&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;wal_level&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; replica
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;PostgreSQL &amp;lt;= 9.5&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;wal_level&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; hot_standby
&lt;/pre&gt;&lt;/div&gt;


&lt;ul&gt;
&lt;li&gt;Enable archive mode&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;archive_mode&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; on
&lt;span class="nv"&gt;archive_command&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;test ! -f /data/postgresql/10/main/archive/%f &amp;amp;&amp;amp; cp %p /data/postgresql/10/main/archive/%f&amp;#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;em&gt;Replace &lt;strong&gt;/data/postgresql/10/main/archive&lt;/strong&gt; with the directory you created above.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Restart service to make the changes effective&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo service postgresql restart
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Prepare Replication Server&lt;/h2&gt;
&lt;h5&gt;Stop service&lt;/h5&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo service postgresql stop
&lt;/pre&gt;&lt;/div&gt;


&lt;h5&gt;Initialize data&lt;/h5&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;Rename old data directory&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;# replace /data/postgresql/10/main with your postgresql data directory (configured in postgresql.conf)
sudo mv /data/postgresql/10/main /data/postgresql/10/main_old
&lt;/pre&gt;&lt;/div&gt;


&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Run backup utility to copy data from Master&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo -u postgres pg_basebackup -h  -D /data/postgresql/10/main -U rep_user -v -P -X stream
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;em&gt;Replace &lt;strong&gt;/data/postgresql/10/main&lt;/strong&gt; with your data directory &amp;amp; &lt;strong&gt;rep_user&lt;/strong&gt; with your replication user above. You will need to provide password for replication user.&lt;/em&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h5&gt;Turn on Hot Standby&lt;/h5&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo vi  /etc/postgresql/10/main/postgresql.conf
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Uncomment this line&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;hot_standby&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; on
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Create recovery file&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo cp /usr/share/postgresql/10/recovery.conf.sample /data/postgresql/10/main/recovery.conf
sudo vi /data/postgresql/10/main/recovery.conf
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Configure stanby&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;standby_mode&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; on
&lt;span class="nv"&gt;primary_conninfo&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;host=[your_master_host] port=[your_master_port] user=[your_replication_user] password=[your_replication_user_password]&amp;#39;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Make sure user &lt;strong&gt;postgres&lt;/strong&gt; has correct permission on postgresql data directory&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo chmod -R &lt;span class="m"&gt;0700&lt;/span&gt; /data/postgresql
sudo chown -R postgres:postgres /data/postgresql
&lt;/pre&gt;&lt;/div&gt;


&lt;h5&gt;Start service&lt;/h5&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo service postgresql start
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Now your &lt;strong&gt;Replication Server&lt;/strong&gt; can serve read-only query. If you want to promote it to &lt;strong&gt;Master&lt;/strong&gt; can use this command:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo -u postgres pg_ctlcluster &lt;span class="m"&gt;10&lt;/span&gt; main promote
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;em&gt;Replace &lt;code&gt;10&lt;/code&gt; with your postgresql version&lt;/em&gt;.&lt;/p&gt;
&lt;hr&gt;
&lt;h2&gt;References&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href="https://cloud.google.com/community/tutorials/setting-up-postgres-hot-standby"&gt;How to Set Up PostgreSQL for High Availability and Replication with Hot Standby&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href="https://www.postgresql.org/docs/10/high-availability.html"&gt;High Availability, Load Balancing, and Replication (PostgreSQL's official documentation)&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;</content><category term="postgresql"></category><category term="ubuntu"></category><category term="linux"></category><category term="devops"></category><category term="replication"></category><category term="stanby"></category><category term="high availability"></category><category term="load balancing"></category></entry><entry><title>Install &amp; configure PostgreSQL on Ubuntu</title><link href="https://viettran.me/install-n-configure-postgresql-on-ubuntu.html" rel="alternate"></link><published>2018-10-08T13:40:00+08:00</published><updated>2018-11-25T14:29:00+08:00</updated><author><name>Viet Tran</name></author><id>tag:viettran.me,2018-10-08:/install-n-configure-postgresql-on-ubuntu.html</id><summary type="html">&lt;p&gt;How to install &amp;amp; configure PostgreSQL on Ubuntu.&lt;/p&gt;</summary><content type="html">&lt;p&gt;&lt;em&gt;This tutorial is using &lt;a href="https://en.wikipedia.org/wiki/Vi"&gt;vi&lt;/a&gt; editor. You can use any editor you want.&lt;/em&gt;&lt;/p&gt;
&lt;h2&gt;Add PostgreSQL repository to &lt;strong&gt;apt&lt;/strong&gt; package list&lt;/h2&gt;
&lt;p&gt;Ubuntu comes with a default version of PostgreSQL. If we need to install a specific version, we have to add the PosgreSQL repository to our package list.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo vi /etc/apt/sources.list.d/pgdg.list
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Add this line:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;deb http://apt.postgresql.org/pub/repos/apt/ xenial-pgdg main
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;em&gt;Replace &lt;code&gt;xenial&lt;/code&gt; with your Ubuntu code name, I use &lt;code&gt;xenial&lt;/code&gt; because I'm using Ubuntu 16.04 LTS&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Import the repository signing key, and update the package list:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc &lt;span class="p"&gt;|&lt;/span&gt; sudo apt-key add -
sudo apt-get update
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Install PostgreSQL&lt;/h2&gt;
&lt;p&gt;Our current system requires PostgreSQL 9.5. So I will install version &lt;strong&gt;9.5&lt;/strong&gt;. Replace it with your choice:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo apt-get install -y postgresql-client-9.5 postgresql-9.5 postgresql-contrib-9.5 postgresql-server-dev-9.5
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;em&gt;From version &lt;strong&gt;10&lt;/strong&gt; you don't have to install &lt;strong&gt;postgresql-contrib-xx&lt;/strong&gt; because it is already added to package &lt;strong&gt;postgresql-xx&lt;/strong&gt;&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;PostgreSQL created a default user, named &lt;strong&gt;postgres&lt;/strong&gt;, during installation. This user doesn't yet have a password, so you'll need to set one.
Run &lt;strong&gt;PSQL&lt;/strong&gt; as user &lt;strong&gt;postgres&lt;/strong&gt;, instead of &lt;strong&gt;root&lt;/strong&gt;, accesssing the database named &lt;strong&gt;postgres&lt;/strong&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo -u postgres psql postgres
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;You should see the PSQL command prompt, which looks like this: &lt;code&gt;postgres=#&lt;/code&gt;. Set the password with this command:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="se"&gt;\p&lt;/span&gt;assword postgres
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;When prompted, enter and confirm the password you've chosen.&lt;/p&gt;
&lt;p&gt;Install the &lt;strong&gt;adminpack&lt;/strong&gt; extension to use with some administration and management tools.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;CREATE EXTENSION adminpack&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;The console prints &lt;strong&gt;CREATE EXTENSION&lt;/strong&gt; when successful.&lt;/p&gt;
&lt;p&gt;Enter &lt;code&gt;\q&lt;/code&gt; to exit &lt;strong&gt;PSQL&lt;/strong&gt;&lt;/p&gt;
&lt;h2&gt;Allow access to PostgreSQL&lt;/h2&gt;
&lt;p&gt;PostgreSQL only allows access from localhost. We need to change its configuratin to allow remote access.&lt;/p&gt;
&lt;h5&gt;Edit &lt;strong&gt;pg_hba.conf&lt;/strong&gt;&lt;/h5&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo vi /etc/postgresql/9.4/main/pg_hba.conf
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;This file contains a very clear information. You can base on this to add your configuration. In this tutorial, I will allow access from all users in my internal network by adding this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# allow access from my internal network with md5 password&lt;/span&gt;
host    all             &lt;span class="m"&gt;10&lt;/span&gt;.20.0.0/16             all                     md5
&lt;/pre&gt;&lt;/div&gt;


&lt;h5&gt;Edit &lt;strong&gt;postgresql.conf&lt;/strong&gt;&lt;/h5&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo vi /etc/postgresql/9.4/main/postgresql.conf
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Find this &lt;code&gt;#listen_addresses = 'localhost'&lt;/code&gt; &amp;amp; replace with &lt;code&gt;listen_addresses = '*'&lt;/code&gt; to allow access from other servers.&lt;/p&gt;
&lt;p&gt;Save the file &amp;amp; exit. Then restart &lt;strong&gt;postgresql&lt;/strong&gt; service:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo service postgresql restart
&lt;/pre&gt;&lt;/div&gt;


&lt;h2&gt;Configure PostgreSQL&lt;/h2&gt;
&lt;p&gt;Below is basic settings for &lt;strong&gt;postgresql.conf&lt;/strong&gt;. Please see &lt;a href="#References"&gt;References&lt;/a&gt; for more detail.&lt;/p&gt;
&lt;h5&gt;Memory&lt;/h5&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;shared_buffers&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; 3GB         &lt;span class="c1"&gt;# 1/4 system available RAM&lt;/span&gt;
&lt;span class="nv"&gt;work_mem&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; 10MB                 &lt;span class="c1"&gt;# up to 1/4(RAM)/max_connections&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h5&gt;Query turning&lt;/h5&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;random_page_cost&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="m"&gt;1&lt;/span&gt;.5          &lt;span class="c1"&gt;# using 1.5 or 2.0 for SSD&lt;/span&gt;
&lt;span class="nv"&gt;effective_cache_size&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; 10GB     &lt;span class="c1"&gt;# 3/4 system available RAM or sum of free &amp;amp; cached value from free -h command&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;em&gt;Remember to save the file and restart postgresql service.&lt;/em&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;h2&gt;References&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://cloud.google.com/community/tutorials/setting-up-postgres"&gt;How to Set Up PostgreSQL on Google Compute Engine&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="https://severalnines.com/blog/setting-optimal-environment-postgresql"&gt;Setting Up an Optimal Environment for PostgreSQL&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><category term="postgresql"></category><category term="ubuntu"></category><category term="linux"></category><category term="devops"></category></entry></feed>